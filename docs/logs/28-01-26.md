# Session Log - 28/01/26

## 11:00 (SGT) - Availability System Refactor

Refactored the availability system from per-user to per-group storage.

**Changes:**
- Updated `AvailabilitySlot` schema from `{dayOfWeek, startTime, endTime}` to `{day, hour}` format
- Added `groupId` to `UpdateAvailabilityRequest` schema
- Rewrote `AvailabilityService` for group-based storage in `useravailabilities` collection
- Made collection names configurable via constructor parameters
- Updated GET/PUT `/api/circles/availability` endpoints to use `groupId`
- Updated `/api/circles/groups/{groupId}/common-availability` to return `{day, hour}` format

**Files Modified:**
- `app_v2/schemas/circles.py`
- `app_v2/services/circles/availability_service.py`
- `app_v2/routers/circles.py`

**New Collection Structure:**
```json
{
  "groupId": "ObjectId",
  "memberAvailability": [
    {
      "userId": "ObjectId",
      "slots": [{"day": 1, "hour": 9}],
      "timezone": "UTC",
      "updatedAt": "datetime"
    }
  ]
}
```

---

## 14:00 (SGT) - Meeting Scheduling with Manual Links

Added ability for users to provide their own meeting link when scheduling.

**Changes:**
- Made `duration` optional with default of 60 minutes in schema
- Added optional `meetingLink` field to `ScheduleMeetingRequest`
- Added optional `timezone` field to `ScheduleMeetingRequest`
- Updated router to pass new fields to `MeetingService`
- Updated `schedule_meeting()` to accept and store `meeting_link` parameter

**Files Modified:**
- `app_v2/schemas/circles.py`
- `app_v2/routers/circles.py`
- `app_v2/services/circles/meeting_service.py`

**API Request Format:**
```json
{
  "title": "Weekly Sync",
  "scheduledAt": "2026-01-29T13:00:00Z",
  "duration": 60,
  "meetingLink": "https://meet.example.com/abc123",
  "timezone": "Europe/Stockholm"
}
```

---

## 15:00 (SGT) - Fix My-Groups Endpoint to Include Next Meeting

Fixed the `/api/circles/my-groups` endpoint to fetch and return the next meeting for each group.

**Problem:**
- After scheduling a meeting, the button in CircleCard didn't change from "Schedule Meeting" to "Join Call"
- The endpoint had `"nextMeeting": None` hardcoded with a TODO comment

**Changes:**
- Updated `/my-groups` endpoint to call `meeting_service.get_next_meeting()` for each group
- Returns meeting data including `id`, `title`, `scheduledAt`, `duration`, `meetingLink`, `timezone`

**Files Modified:**
- `app_v2/routers/circles.py`

**API Response Format:**
```json
{
  "groups": [
    {
      "id": "...",
      "name": "Circle A",
      "memberCount": 4,
      "members": [...],
      "nextMeeting": {
        "id": "...",
        "title": "Weekly Sync",
        "scheduledAt": "2026-01-29T13:00:00+00:00",
        "duration": 60,
        "meetingLink": "https://meet.example.com/abc123",
        "timezone": "Europe/Stockholm"
      }
    }
  ]
}
```

---

## 15:30 (SGT) - Fix Group Meetings Endpoint for View Details Modal

Fixed the `/api/circles/groups/{group_id}/meetings` endpoint to return correct fields for the GroupDetailsModal.

**Problem:**
- Modal expected `scheduledAt`, `meetingLink`, `status` fields
- Endpoint returned `date` instead of `scheduledAt` and was missing other fields
- Endpoint only returned upcoming meetings, but modal shows both upcoming and past

**Changes:**
- Added optional `upcoming` query parameter (defaults to false to return all meetings)
- Changed `date` field to `scheduledAt`
- Added `meetingLink`, `status`, `duration`, `timezone` fields to response

**Files Modified:**
- `app_v2/routers/circles.py`

**API Response Format:**
```json
{
  "meetings": [
    {
      "id": "...",
      "title": "Weekly Sync",
      "scheduledAt": "2026-01-29T13:00:00+00:00",
      "duration": 60,
      "meetingLink": "https://meet.example.com/abc123",
      "status": "scheduled",
      "timezone": "Europe/Stockholm"
    }
  ]
}
```

---

## 16:00 (SGT) - Denormalize Member Names in Collections

Stored member names directly in `circlegroups` and `useravailabilities` collections for better performance (no repeated user lookups).

**Changes:**
- `circlegroups.members` now stores `[{userId, name}]` instead of `[ObjectId]`
- `useravailabilities.memberAvailability` now includes `name` field
- Updated all queries to use `members.userId` instead of `members`
- One-time user lookup at group assignment time

**Files Modified:**
- `app_v2/services/circles/group_service.py` - Store names at assignment, update all member queries
- `app_v2/services/circles/meeting_service.py` - Update membership checks
- `app_v2/services/circles/availability_service.py` - Store names, update member ID extraction
- `app_v2/routers/circles.py` - Format members from new structure

**New Schema:**
```json
// circlegroups.members
[
  {"userId": ObjectId("..."), "name": "Anna Svensson"},
  {"userId": ObjectId("..."), "name": "Erik Lindqvist"}
]

// useravailabilities.memberAvailability
[
  {"userId": ObjectId("..."), "name": "Anna Svensson", "slots": [...], "timezone": "UTC"}
]
```
