# Session Log - 28/01/26

## 11:00 (SGT) - Availability System Refactor

Refactored the availability system from per-user to per-group storage.

**Changes:**
- Updated `AvailabilitySlot` schema from `{dayOfWeek, startTime, endTime}` to `{day, hour}` format
- Added `groupId` to `UpdateAvailabilityRequest` schema
- Rewrote `AvailabilityService` for group-based storage in `useravailabilities` collection
- Made collection names configurable via constructor parameters
- Updated GET/PUT `/api/circles/availability` endpoints to use `groupId`
- Updated `/api/circles/groups/{groupId}/common-availability` to return `{day, hour}` format

**Files Modified:**
- `app_v2/schemas/circles.py`
- `app_v2/services/circles/availability_service.py`
- `app_v2/routers/circles.py`

**New Collection Structure:**
```json
{
  "groupId": "ObjectId",
  "memberAvailability": [
    {
      "userId": "ObjectId",
      "slots": [{"day": 1, "hour": 9}],
      "timezone": "UTC",
      "updatedAt": "datetime"
    }
  ]
}
```

---

## 14:00 (SGT) - Meeting Scheduling with Manual Links

Added ability for users to provide their own meeting link when scheduling.

**Changes:**
- Made `duration` optional with default of 60 minutes in schema
- Added optional `meetingLink` field to `ScheduleMeetingRequest`
- Added optional `timezone` field to `ScheduleMeetingRequest`
- Updated router to pass new fields to `MeetingService`
- Updated `schedule_meeting()` to accept and store `meeting_link` parameter

**Files Modified:**
- `app_v2/schemas/circles.py`
- `app_v2/routers/circles.py`
- `app_v2/services/circles/meeting_service.py`

**API Request Format:**
```json
{
  "title": "Weekly Sync",
  "scheduledAt": "2026-01-29T13:00:00Z",
  "duration": 60,
  "meetingLink": "https://meet.example.com/abc123",
  "timezone": "Europe/Stockholm"
}
```

---

## 15:00 (SGT) - Fix My-Groups Endpoint to Include Next Meeting

Fixed the `/api/circles/my-groups` endpoint to fetch and return the next meeting for each group.

**Problem:**
- After scheduling a meeting, the button in CircleCard didn't change from "Schedule Meeting" to "Join Call"
- The endpoint had `"nextMeeting": None` hardcoded with a TODO comment

**Changes:**
- Updated `/my-groups` endpoint to call `meeting_service.get_next_meeting()` for each group
- Returns meeting data including `id`, `title`, `scheduledAt`, `duration`, `meetingLink`, `timezone`

**Files Modified:**
- `app_v2/routers/circles.py`

**API Response Format:**
```json
{
  "groups": [
    {
      "id": "...",
      "name": "Circle A",
      "memberCount": 4,
      "members": [...],
      "nextMeeting": {
        "id": "...",
        "title": "Weekly Sync",
        "scheduledAt": "2026-01-29T13:00:00+00:00",
        "duration": 60,
        "meetingLink": "https://meet.example.com/abc123",
        "timezone": "Europe/Stockholm"
      }
    }
  ]
}
```

---

## 15:30 (SGT) - Fix Group Meetings Endpoint for View Details Modal

Fixed the `/api/circles/groups/{group_id}/meetings` endpoint to return correct fields for the GroupDetailsModal.

**Problem:**
- Modal expected `scheduledAt`, `meetingLink`, `status` fields
- Endpoint returned `date` instead of `scheduledAt` and was missing other fields
- Endpoint only returned upcoming meetings, but modal shows both upcoming and past

**Changes:**
- Added optional `upcoming` query parameter (defaults to false to return all meetings)
- Changed `date` field to `scheduledAt`
- Added `meetingLink`, `status`, `duration`, `timezone` fields to response

**Files Modified:**
- `app_v2/routers/circles.py`

**API Response Format:**
```json
{
  "meetings": [
    {
      "id": "...",
      "title": "Weekly Sync",
      "scheduledAt": "2026-01-29T13:00:00+00:00",
      "duration": 60,
      "meetingLink": "https://meet.example.com/abc123",
      "status": "scheduled",
      "timezone": "Europe/Stockholm"
    }
  ]
}
```

---

## 16:00 (SGT) - Denormalize Member Names in Collections

Stored member names directly in `circlegroups` and `useravailabilities` collections for better performance (no repeated user lookups).

**Changes:**
- `circlegroups.members` now stores `[{userId, name}]` instead of `[ObjectId]`
- `useravailabilities.memberAvailability` now includes `name` field
- Updated all queries to use `members.userId` instead of `members`
- One-time user lookup at group assignment time

**Files Modified:**
- `app_v2/services/circles/group_service.py` - Store names at assignment, update all member queries
- `app_v2/services/circles/meeting_service.py` - Update membership checks
- `app_v2/services/circles/availability_service.py` - Store names, update member ID extraction
- `app_v2/routers/circles.py` - Format members from new structure

**New Schema:**
```json
// circlegroups.members
[
  {"userId": ObjectId("..."), "name": "Anna Svensson"},
  {"userId": ObjectId("..."), "name": "Erik Lindqvist"}
]

// useravailabilities.memberAvailability
[
  {"userId": ObjectId("..."), "name": "Anna Svensson", "slots": [...], "timezone": "UTC"}
]
```

---

## 20:00 (SGT) - Today's Focus Feature Implementation

Implemented the "Today's Focus" feature for the Dashboard - a shuffled learning playlist that rotates daily.

### Backend Changes

**New Files Created:**
- `app_v2/services/learning/__init__.py` - Learning services module
- `app_v2/services/learning/learning_queue_service.py` - Queue CRUD operations
- `app_v2/pipelines/learning.py` - Today's Focus pipeline logic

**Files Modified:**
- `app_v2/pipelines/__init__.py` - Added learning pipeline export
- `app_v2/dependencies.py` - Added `init_learning_queue_services()` and `get_learning_queue_service()`
- `app_v2/routers/dashboard.py` - Now calls pipeline and returns `todaysFocus` with module data

### Frontend Changes

**Files Modified:**
- `src/pages/Dashboard.jsx`:
  - Added ArticleModal and AudioModal imports
  - Added modal state management
  - Added `getTodaysFocusTitle()` for localized titles
  - Added `openTodaysFocus()` to fetch module and open appropriate modal
  - Added loading spinner on Continue button
  - Removed progress bar from Today's Focus card
- `src/prototype.css`:
  - Added `.btn-loading` and `.spinner-icon` styles

### Feature Behavior

1. **New users**: Creates shuffled queue from all published `contentitems`
2. **Daily rotation**: Index advances once per day (tracked via `lastAdvancedDate`)
3. **Cycle completion**: Queue reshuffles when all modules viewed
4. **Deleted content**: Auto-reshuffles if current module no longer exists

### Database Collection

`userlearningqueues` (main database):
```json
{
  "_id": "ObjectId",
  "userId": "ObjectId",
  "queue": ["content_id_1", "content_id_2", ...],
  "currentIndex": 0,
  "lastAdvancedDate": "2026-01-28",
  "createdAt": "datetime",
  "updatedAt": "datetime"
}
```

### API Response Structure

```json
{
  "todaysFocus": {
    "module": {
      "id": "694e2888323051422a93d572",
      "contentType": "text_article",
      "category": "leadership",
      "titleEn": "Team Dynamics & Conflict Resolution",
      "titleSv": "Teamdynamik & Konfliktlösning",
      "lengthMinutes": 9
    },
    "currentIndex": 0,
    "totalModules": 61,
    "progress": 0.0
  }
}
```

### Frontend Flow

1. Dashboard loads → fetches `/api/dashboard` with `todaysFocus`
2. User clicks "Continue" → shows loading spinner
3. Fetches full module via `/api/learning/content/{id}`
4. Opens modal based on `contentType`:
   - `text_article` → ArticleModal
   - `audio_article` / `audio_exercise` → AudioModal
   - `video_link` → Opens in new tab

---

## 21:30 (SGT) - TTS Configuration Refactor & Swedish Voice

Moved config from `common/config/` to root `config/` folder and added language-specific TTS defaults for Swedish.

### Config Folder Restructure

**Moved:**
- `common/config/base_settings.py` → `config/base_settings.py`
- `common/config/__init__.py` → `config/__init__.py`

**Created:**
- `config/tts_config.py` - Voice mappings and language defaults

**Deleted:**
- `common/config/` folder

**Updated imports:**
- `app_v1/config.py` - `from common.config` → `from config`
- `common/__init__.py` - `from common.config` → `from config`

### TTS Language-Specific Defaults

Added Swedish voice (Elin) with Flash 2.5 model for better Swedish pronunciation.

**config/tts_config.py:**
```python
VOICE_MAPPINGS = {
    "Aria": "fO844Om1VZLpw8IpZj3T",
    "Elin": "4Ct5uMEndw4cJ7q0Jx0l",
    # ... other voices
}

TTS_DEFAULTS = {
    "en": {
        "voice": "Aria",
        "model": "eleven_multilingual_v2",
    },
    "sv": {
        "voice": "Elin",
        "model": "eleven_flash_v2_5",
    },
}
```

### Service Changes

**Files Modified:**
- `app_v2/services/media/tts_service.py`:
  - Imports `VOICE_MAPPINGS`, `TTS_DEFAULTS` from `config.tts_config`
  - Added `language` parameter to `generate_speech()`
  - Uses language-specific defaults when voice not specified

- `app_v2/schemas/coach.py`:
  - Changed `voice` default from `"Aria"` to `None` (uses language default)

- `app_v2/routers/coach.py`:
  - Passes `body.language` to `generate_speech()`

### Result

| Language | Voice | Model |
|----------|-------|-------|
| English | Aria | eleven_multilingual_v2 |
| Swedish | Elin | eleven_flash_v2_5 |

---

## 23:00 (SGT) - Chat Translation Feature

Implemented on-demand translation for coach conversation history when users switch languages.

### Backend Changes

**New Files Created:**
- `app_v2/services/translation/__init__.py` - Translation services module
- `app_v2/services/translation/translation_service.py` - Claude-based batch translation
- `app_v2/pipelines/translation.py` - Translation pipeline with caching

**Files Modified:**
- `app_v2/dependencies.py`:
  - Added `TranslationService` import
  - Added `_translation_service` global
  - Added `init_translation_services()` function
  - Added `get_translation_service()` getter
  - Called initialization in `init_all_services()`

- `app_v2/routers/coach.py`:
  - Added `POST /api/coach/conversations/translate` endpoint
  - Imports `TranslationService` and `translation_pipeline`

- `app_v2/schemas/coach.py`:
  - Added `TranslateConversationRequest` schema
  - Added `TranslatedMessageResponse` schema
  - Added `TranslateConversationResponse` schema

- `app_v2/pipelines/conversation.py`:
  - Added `language` parameter to `save_message()`
  - Added `translations` field to message document

- `app_v2/pipelines/__init__.py`:
  - Added translation pipeline export

### API Endpoint

**POST** `/api/coach/conversations/translate`

**Request:**
```json
{
  "conversationId": "conv_20260128...",
  "targetLanguage": "sv",
  "startIndex": null,
  "count": 20
}
```

**Response:**
```json
{
  "translatedMessages": [
    {
      "index": 0,
      "content": "Translated content...",
      "alreadyInTargetLanguage": false,
      "fromCache": false,
      "newlyTranslated": true
    }
  ],
  "totalMessages": 10,
  "startIndex": 0,
  "endIndex": 10,
  "newlyTranslated": 5,
  "fromCache": 3
}
```

### Message Schema Update

Messages now include `language` and `translations` fields:
```json
{
  "role": "user",
  "content": "encrypted_content",
  "encrypted": true,
  "language": "en",
  "timestamp": "datetime",
  "metadata": {},
  "translations": {
    "sv": "encrypted_swedish_translation"
  }
}
```

### Features

1. **Windowed Translation**: Translates last 20 messages by default, can request more
2. **Translation Caching**: Translations stored encrypted in message document
3. **Skip Already Translated**: Returns cached translations without re-translating
4. **Language Detection**: Skips messages already in target language
5. **Batch Translation**: Uses Claude API for batch translation efficiency

---

## 23:30 (SGT) - Translation Bug Fixes

Fixed several issues with the translation feature.

### Bug 1: Invalid ObjectId for conversationId

**Problem:** Translation pipeline was using `ObjectId(conversation_id)` but conversations use string-based IDs like `conv_20260128_abc123`.

**Fix:** Changed queries to use `conversationId` field instead of `_id`:
```python
# Before
{"_id": ObjectId(conversation_id), "userId": ObjectId(user_id)}

# After
{"conversationId": conversation_id, "userId": ObjectId(user_id)}
```

**Files Modified:**
- `app_v2/pipelines/translation.py` - 3 query updates

### Bug 2: ClaudeProvider method name

**Problem:** TranslationService called `self._claude.generate()` but ClaudeProvider uses `chat()`.

**Fix:** Updated to correct method and parameters:
```python
# Before
response = await self._claude.generate(prompt=prompt, system="...", max_tokens=4096)

# After
response = await self._claude.chat(message=prompt, system_prompt="...", max_tokens=4096)
```

**Files Modified:**
- `app_v2/services/translation/translation_service.py`

### Bug 3: Encrypted messages not being decrypted

**Problem:** `_decrypt_content()` was checking for `"enc:"` prefix and passing `user_id`, but MemoryEncryptionService uses base64 encoding and doesn't require user_id.

**Fix:** Updated decryption logic to match conversation pipeline:
```python
# Before
def _decrypt_content(content: str, encryption_service, user_id: str) -> str:
    if content and content.startswith("enc:"):
        return encryption_service.decrypt(content, user_id)

# After
def _decrypt_content(content: str, encryption_service, is_encrypted: bool = True) -> str:
    if content and is_encrypted:
        decrypted = encryption_service.decrypt(content)
        if decrypted is not None:
            return decrypted
```

**Files Modified:**
- `app_v2/pipelines/translation.py` - Updated `_decrypt_content()` and `_encrypt_content()` signatures and all call sites
