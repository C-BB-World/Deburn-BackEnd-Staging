# Session Log - 13/01/26

## 21:30 (SGT) - CORS Error Investigation

Initial deployment to Render showed CORS errors. Diagnosed that CORS was actually configured correctly - the real issue was 500 Internal Server Errors causing responses to bypass CORS middleware.

---

## 21:45 (SGT) - Fixed JWTAuth Parameter Mismatch

`app/dependencies.py` was passing `secret_key` to `JWTAuth`, but the class expected `secret`. Also removed invalid `refresh_token_expire_days` parameter.

**File:** `app/dependencies.py`

---

## 22:00 (SGT) - Added Logging to Auth Router

Added comprehensive logging to all auth endpoints (`/register`, `/login`, `/logout`, `/forgot-password`, `/reset-password`, `/verify-email`, `/resend-verification`) to aid debugging.

**File:** `app/routers/auth.py`

---

## 22:15 (SGT) - Fixed Bcrypt 72-byte Limit

Registration was failing due to bcrypt's 72-byte password limit in Python 3.13. Implemented SHA-256 pre-hashing before bcrypt with backwards compatibility for existing hashes.

**File:** `common/auth/jwt_auth.py`

---

## 22:30 (SGT) - Added Logging to Database Module

Added logging to MongoDB connection manager and BaseDocument for tracking database operations, connections, and disconnections.

**Files:** `common/database/mongodb.py`, `common/database/base_document.py`

---

## 22:45 (SGT) - Fixed Missing Await on create_token

Login was failing silently because `auth.create_token()` is async but was called without `await`.

**File:** `app/routers/auth.py`

---

## 23:00 (SGT) - Fixed Database Name Mismatch

`find_one` was returning 0 users because the app was connecting to default database `app` instead of `deburn`. Changed default `MONGODB_DATABASE` to `deburn`.

**File:** `common/config/base_settings.py`

---

## 23:15 (SGT) - Fixed Index Conflicts

Beanie was trying to create indexes that conflicted with existing MongoDB indexes (different options like `unique`, `sparse`). Removed duplicate index definitions from model Settings.

**Files:** `app/models/user.py`, `app/models/organization.py`

---

## 23:30 (SGT) - Fixed Schema Mismatch for passwordHash

Existing database uses `passwordHash` (camelCase from Mongoose) but Python model expected `password_hash` (snake_case). Added Pydantic alias and `populate_by_name` config.

**File:** `app/models/user.py`

---

## 23:45 (SGT) - Replaced passlib with bcrypt

`passlib` is incompatible with Python 3.13. Switched to using `bcrypt` library directly. Maintains backwards compatibility with existing password hashes.

**Files:** `common/auth/jwt_auth.py`, `requirements.txt`

---

## Summary

Login endpoint is now fully functional on staging. Remaining work: other API paths may have similar schema mismatches between Python models and existing MongoDB documents.
