# Session Log - 26/01/26

## 14:00 (SGT) - MongoDB Prompt Sync

Synced AI prompts between deburnalpha and Deburn-BackEnd:

1. **Queried MongoDB** (`deburn-hub.aiprompt` collection) to verify stored prompts
2. **Compared with deburnalpha files** - Found discrepancies (deburnalpha files were newer)
3. **Updated MongoDB** with content from deburnalpha prompt files (version 2)
4. **Created local prompt files** in `Deburn-BackEnd/prompts/system/{en,sv}/`

Prompt components synced:
- `base-coach.md` - Core coaching personality & instructions
- `safety-rules.md` - Safety constraints and escalation protocols
- `tone-guidelines.md` - Voice and communication style

All three sources now match: MongoDB, Deburn-BackEnd files, deburnalpha files.

---

## 14:30 (SGT) - AI_PROMPT_SOURCE Environment Variable

Added configurable prompt source via environment variable:

**Files modified:**

| File | Change |
|------|--------|
| `.env` | Added `AI_PROMPT_SOURCE=aiprompt` |
| `common/config/base_settings.py` | Added `AI_PROMPT_SOURCE` setting with default `"aiprompt"` |
| `app_v2/agent/prompt_service.py` | Added dual-source support (`"aiprompt"` or `"file"`) |
| `app_v2/dependencies.py` | Reads env var and passes to PromptService |

**Usage:**
```bash
# Use MongoDB (default)
AI_PROMPT_SOURCE=aiprompt

# Use local markdown files
AI_PROMPT_SOURCE=file
```

When using `file` source, prompts are loaded from `prompts/system/{lang}/*.md` and combined with the same `"\n\n---\n\n"` separator as MongoDB.

---

## 14:45 (SGT) - PyMongo Boolean Fix

Fixed startup error in PromptService:

**Error:** `NotImplementedError: Database objects do not implement truth value testing`

**Cause:** Used `if db` instead of `if db is not None` for PyMongo database objects

**Fix:** Changed line 58 in `prompt_service.py`:
```python
# Before
self._collection = db["aiprompt"] if db else None

# After
self._collection = db["aiprompt"] if db is not None else None
```

Server now starts successfully with health check passing.

---

## 15:00 (SGT) - Verification

Tested server startup:
```bash
python3 api_v2.py
```

Health check response:
```json
{
  "success": true,
  "data": {
    "status": "ok",
    "version": "2.0.0",
    "database": true,
    "hub_database": true
  }
}
```

All services initialized successfully with prompt source from MongoDB.

---

## 16:00 (SGT) - Coach Preferences API

Added backend support for persisting coach preferences (voice settings) to MongoDB.

**Files created:**

| File | Purpose |
|------|---------|
| `app_v2/pipelines/preferences.py` | Pipeline functions for get/update preferences |

**Files modified:**

| File | Change |
|------|--------|
| `app_v2/schemas/user.py` | Added `CoachPreferences`, `CoachPreferencesResponse`, `CoachPreferencesUpdateRequest` schemas |
| `app_v2/routers/user.py` | Added `GET /user/preferences` and `PATCH /user/preferences` endpoints |
| `app_v2/services/media/tts_service.py` | Added missing voices (Callum, Liam, Daniel) |

**API Endpoints:**

```
GET /api/user/preferences
Response: { "success": true, "data": { "coachPreferences": { "voice": "Alice" } } }

PATCH /api/user/preferences
Body: { "coachPreferences": { "voice": "Roger" } }
Response: { "success": true, "data": { "coachPreferences": { "voice": "Roger" } } }
```

**Valid Voices:**

| High Pitch | Low Pitch |
|------------|-----------|
| Aria, Sarah, Laura, Alice (default), Matilda, Jessica, Lily | Roger, Charlie, George, Callum, Liam, Daniel |

**Database Schema:**

Preferences stored in separate `userpreferences` collection:
```json
{
  "_id": ObjectId("..."),
  "userId": ObjectId("..."),
  "coachPreferences": {
    "voice": "Alice"
  },
  "createdAt": ISODate("..."),
  "updatedAt": ISODate("...")
}
```

---

## 16:30 (SGT) - User Preferences on Registration & Migration

Added automatic preferences creation on user registration and migration script for existing users.

**Files modified:**

| File | Change |
|------|--------|
| `app_v2/routers/auth.py` | Creates default preferences in `userpreferences` collection after user registration |

**Files created:**

| File | Purpose |
|------|---------|
| `scripts/migrate_user_preferences.py` | Migration script to create default preferences for existing users |

**Registration Flow:**
1. User registers via `/api/auth/register`
2. User document created in `users` collection
3. Default preferences created in `userpreferences` collection with `voice: "Alice"`

**Migration Script Usage:**
```bash
python scripts/migrate_user_preferences.py
```

The script:
- Finds all users without a preferences document
- Creates default preferences (`voice: "Alice"`) for each
- Uses upsert pattern to avoid duplicates

---

## 17:00 (SGT) - Centralized MongoDB Access

Refactored to use centralized MongoDB access through `common/database/mongodb.py`.

**Files modified:**

| File | Change |
|------|--------|
| `common/database/mongodb.py` | Added singleton pattern, collection helpers |
| `common/database/__init__.py` | Exported new functions |
| `app_v2/dependencies.py` | Sets centralized singletons on init |
| `app_v2/pipelines/preferences.py` | Uses `get_userpreferences_collection()` |
| `app_v2/routers/user.py` | Removed direct db access, uses pipelines |
| `app_v2/routers/auth.py` | Uses `create_default_preferences()` pipeline |

**Generic functions in `common/database` (reusable across projects):**

```python
# Singleton management
set_main_database(db)   # Set main DB singleton
set_hub_database(db)    # Set hub DB singleton
get_main_database()     # Returns MongoDB instance
get_hub_database()      # Returns MongoDB instance
```

**Deburn-specific collection helpers in `app_v2/database`:**

```python
# Main database (deburn)
get_users_collection()
get_userpreferences_collection()
get_checkins_collection()
get_circles_collection()

# Hub database (deburn-hub)
get_conversations_collection()
get_aiprompt_collection()
```

**Usage:**
```python
from app_v2.database import get_userpreferences_collection

collection = get_userpreferences_collection()
await collection.find_one({"userId": user_id})
```

**SOLID Principles Applied:**
- `common/database/mongodb.py` - Generic, reusable for any project
- `app_v2/database/collections.py` - Deburn-specific collection accessors

All imports moved to top of files per coding standards.
