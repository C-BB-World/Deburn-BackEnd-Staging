# Session Log - 27/01/26

## Registration Fix - Duplicate Email Check

Fixed registration flow where users could create orphaned Firebase accounts when email already existed in MongoDB.

**Problem:**
- Registration checked `firebaseUid` in MongoDB but not `email`
- If email existed (unique index), Firebase user was created first, then MongoDB insert failed
- Result: orphaned Firebase users with no corresponding MongoDB record

**Solution:**
- Added email check in MongoDB BEFORE creating Firebase user
- If email exists, return error immediately without touching Firebase

**Files Changed:**
- `app_v2/routers/auth.py` - Added `get_user_by_email()` check before Firebase creation

**Debug Print Statements Added:**
- `[REGISTER] Starting registration for email: ...`
- `[REGISTER] Checking if email exists in MongoDB: ...`
- `[REGISTER] Email already exists in MongoDB: ...`
- `[REGISTER] Creating Firebase user: ...`
- `[REGISTER] Firebase user created with UID: ...`
- `[REGISTER] Creating user in MongoDB: ...`
- `[REGISTER] MongoDB user created with ID: ...`
- `[REGISTER] Creating default preferences for user: ...`
- `[REGISTER] Sending verification email to: ...`
- `[REGISTER] Registration complete for: ...`

---

## Email Branding - Environment Variables

Updated email service to use environment variables for branding, replacing hardcoded "Deburn" references.

**New Environment Variables:**
- `SMTP_FROM_NAME` - Sender display name (default: "Human First AI")
- `EMAIL_TEAM_NAME` - Team name for email signatures (default: "The Human First AI Team")

**Files Changed:**
- `.env` - Updated `SMTP_FROM_NAME`, added `EMAIL_TEAM_NAME`
- `app_v2/services/email/email_service.py`:
  - Added `team_name` parameter with env var support
  - Updated default `from_name` from "Deburn" to "Human First AI"
  - Updated all email templates to use `{self._team_name}`:
    - Verification email (HTML + text)
    - Circle invitation email (HTML + text)
    - Password reset email (HTML + text)

---

## Coach Daily Limit Reset

Reset daily exchange count for all users to allow continued testing.

**Command Used:**
```python
await db.users.update_many({}, {"$set": {"coachExchanges.dailyCount": 0}})
```

**Result:** Reset for 21 users
