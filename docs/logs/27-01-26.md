# Session Log - 27/01/26

## Registration Fix - Duplicate Email Check

Fixed registration flow where users could create orphaned Firebase accounts when email already existed in MongoDB.

**Problem:**
- Registration checked `firebaseUid` in MongoDB but not `email`
- If email existed (unique index), Firebase user was created first, then MongoDB insert failed
- Result: orphaned Firebase users with no corresponding MongoDB record

**Solution:**
- Added email check in MongoDB BEFORE creating Firebase user
- If email exists, return error immediately without touching Firebase

**Files Changed:**
- `app_v2/routers/auth.py` - Added `get_user_by_email()` check before Firebase creation

**Debug Print Statements Added:**
- `[REGISTER] Starting registration for email: ...`
- `[REGISTER] Checking if email exists in MongoDB: ...`
- `[REGISTER] Email already exists in MongoDB: ...`
- `[REGISTER] Creating Firebase user: ...`
- `[REGISTER] Firebase user created with UID: ...`
- `[REGISTER] Creating user in MongoDB: ...`
- `[REGISTER] MongoDB user created with ID: ...`
- `[REGISTER] Creating default preferences for user: ...`
- `[REGISTER] Sending verification email to: ...`
- `[REGISTER] Registration complete for: ...`

---

## Email Branding - Environment Variables

Updated email service to use environment variables for branding, replacing hardcoded "Deburn" references.

**New Environment Variables:**
- `SMTP_FROM_NAME` - Sender display name (default: "Human First AI")
- `EMAIL_TEAM_NAME` - Team name for email signatures (default: "The Human First AI Team")

**Files Changed:**
- `.env` - Updated `SMTP_FROM_NAME`, added `EMAIL_TEAM_NAME`
- `app_v2/services/email/email_service.py`:
  - Added `team_name` parameter with env var support
  - Updated default `from_name` from "Deburn" to "Human First AI"
  - Updated all email templates to use `{self._team_name}`:
    - Verification email (HTML + text)
    - Circle invitation email (HTML + text)
    - Password reset email (HTML + text)

---

## Coach Daily Limit Reset

Reset daily exchange count for all users to allow continued testing.

**Command Used:**
```python
await db.users.update_many({}, {"$set": {"coachExchanges.dailyCount": 0}})
```

**Result:** Reset for 21 users

---

## Check-in Insight Persistence

Added persistence for AI-generated check-in insights so they show up on the dashboard.

**Problem:**
- When a user submitted a check-in, an AI-generated insight and tip were returned in the response
- These insights were only displayed on the check-in completion screen
- If the user navigated away or logged in later, the insight was lost
- The dashboard showed "X insights waiting" but check-in insights weren't being counted

**Solution:**
- When a check-in is submitted, the generated insight is now saved to the `insights` collection
- The insight has a 24-hour expiration (relevant for today only)
- Duplicate prevention: If user retakes check-in on the same day, a new insight is NOT created
- The persisted insight now counts towards `insightsCount` on the dashboard

**Files Changed:**
- `app_v2/pipelines/checkin.py`:
  - Added `InsightService` import
  - Added `insight_service` parameter to `submit_checkin_pipeline()`
  - Added logic to persist insight to `insights` collection
  - Added duplicate check using `has_recent_insight()` with 1-day window
- `app_v2/routers/checkin.py`:
  - Added `get_insight_service` dependency
  - Added `InsightService` import
  - Updated `submit_checkin` endpoint to inject and pass `insight_service`

**Insight Document Created:**
```python
{
    "userId": ObjectId,
    "type": "checkin",
    "trigger": "daily_checkin",
    "title": "Today's Check-in Insight",
    "description": "<insight>\n\nTip: <tip>",
    "metrics": {"mood": int, "stress": int, "sleep": int},
    "isRead": False,
    "expiresAt": datetime (24 hours from now),
    "createdAt": datetime
}
```

---

## Check-in Insight Update on Retake

Changed check-in insight behavior from skip-on-duplicate to update-on-retake.

**Previous Behavior:**
- If user retook check-in on same day, the existing insight was kept (no new insight created)
- User would see the same old insight even after retaking with different metrics

**New Behavior:**
- Same-day retake: Update existing insight with new AI-generated content
- Different day: Create new insight (previous day's insight expires via 24h TTL)
- On update, `isRead` is reset to `false` so user sees the new insight

**Files Changed:**
- `app_v2/services/progress/insight_service.py`:
  - Added `update_or_create_checkin_insight()` method
  - Finds existing insight created today (using start-of-day comparison)
  - If found: updates title, description, metrics, expiresAt, resets isRead
  - If not found: creates new insight document
- `app_v2/pipelines/checkin.py`:
  - Removed `has_recent_insight()` check and skip logic
  - Now calls `update_or_create_checkin_insight()` directly
  - Added all 5 metrics (mood, physicalEnergy, mentalEnergy, sleep, stress)

**Insight Document Structure:**
```python
{
    "userId": ObjectId,
    "type": "checkin",
    "trigger": "daily_checkin",
    "title": "Today's Check-in Insight",
    "description": "<insight>\n\nTip: <tip>",
    "metrics": {
        "mood": int,
        "physicalEnergy": int,
        "mentalEnergy": int,
        "sleep": int,
        "stress": int
    },
    "isRead": False,
    "expiresAt": datetime (24 hours from now),
    "createdAt": datetime,
    "updatedAt": datetime
}
```

**Recommended Index:**
```javascript
db.insights.createIndex(
  { "userId": 1, "trigger": 1, "createdAt": -1 },
  { name: "user_trigger_date" }
)
```

---

## Bilingual Check-in Insights + Dashboard Display

Added Swedish translation support for check-in insights and dashboard display.

**Changes:**

1. **Insight Generator now outputs bilingual content**
   - Prompt asks AI for both English and Swedish versions
   - Parses `INSIGHT_EN`, `INSIGHT_SV`, `TIP_EN`, `TIP_SV` format
   - Fallback messages include Swedish translations

2. **Prompt moved to external file**
   - Created `prompts/system/en/checkin-insight.md`
   - InsightGenerator loads prompt from file (with hardcoded fallback)
   - Easier to edit and maintain

3. **Configurable lookback period**
   - Added `INSIGHT_LOOKBACK_DAYS` env variable (default: 7)
   - Added to `common/config/base_settings.py`

4. **Dashboard now shows today's insight**
   - Added `todaysInsight` and `todaysInsightSv` fields to dashboard response
   - Frontend displays insight in current language above "Week at a Glance"

**Files Created:**
- `prompts/system/en/checkin-insight.md` - Bilingual insight prompt template

**Backend Files Modified:**
- `app_v2/services/checkin/insight_generator.py`:
  - Load prompt from file
  - Parse bilingual output (EN + SV)
  - Configurable lookback days
  - Include day-of-week in history for pattern detection
- `app_v2/services/progress/insight_service.py`:
  - Added `titleSv` and `descriptionSv` fields
  - Added `get_todays_checkin_insight()` method
  - Updated `_format_insight()` to include Swedish fields
- `app_v2/pipelines/checkin.py`:
  - Pass Swedish content to insight service
  - Return Swedish fields in response
- `app_v2/routers/dashboard.py`:
  - Fetch and return `todaysInsight` and `todaysInsightSv`
- `mocks/mock_v2.py`:
  - Added `todaysInsight` and `todaysInsightSv` to mock dashboard
- `common/config/base_settings.py`:
  - Added `INSIGHT_LOOKBACK_DAYS` setting
- `.env`:
  - Added `INSIGHT_LOOKBACK_DAYS=7`

**Frontend Files Modified:**
- `src/pages/Dashboard.jsx`:
  - Added insight message box section above "Week at a Glance"
  - Displays insight in current language (EN/SV)
- `src/locales/en/dashboard.json`:
  - Added `insightCard.title` and `insightCard.noInsight`
- `src/locales/sv/dashboard.json`:
  - Added Swedish translations for insight card
- `src/prototype.css`:
  - Added `.insight-section` styling

**Updated Insight Document Structure:**
```python
{
    "userId": ObjectId,
    "type": "checkin",
    "trigger": "daily_checkin",
    "title": "Today's Check-in Insight",
    "titleSv": "Dagens incheckningsinsikt",
    "description": "<insight EN>\n\nTip: <tip EN>",
    "descriptionSv": "<insight SV>\n\nTips: <tip SV>",
    "metrics": {...},
    "isRead": False,
    "expiresAt": datetime,
    "createdAt": datetime,
    "updatedAt": datetime
}
```

---

## Future Consideration: Database-Driven Prompts

**Note for future implementation:**

Currently, the check-in insight prompt is stored in a file (`prompts/system/en/checkin-insight.md`). Consider migrating to database-driven prompts using the existing `PromptService` infrastructure for:

- Admin-editable prompts without code deployment
- Version history and rollback
- A/B testing different prompt variations
- Consistent pattern with coaching prompts

The `PromptService` already supports:
- MongoDB `aiprompt` collection storage
- Multi-language content (`content.en`, `content.sv`)
- Caching with TTL
- File fallback

To migrate: Add `checkin` as a supported prompt type in `PromptService` and update `InsightGenerator` to use it instead of direct file loading.
