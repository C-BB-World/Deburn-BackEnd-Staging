# Research Log - January 18, 2026

## Task
Researching circles pipeline and frontend integration, specifically:
1. How is a user defined as a Group Admin?
2. What database/collections are involved?
3. How do invitations work?
4. Calendar integration overview

---

## Findings

### 1. Group Admin Definition

A "Group Admin" in the circles context is an **Organization Admin**. This is determined via the `organizationMembers` collection.

**Database:** `organizationMembers` collection

**Schema:**
```python
{
    "_id": ObjectId,
    "organizationId": ObjectId,    # Organization reference
    "userId": ObjectId,            # User reference
    "role": str,                   # "admin" | "member"
    "status": str,                 # "active" | "inactive" | "removed"
    "joinedAt": datetime,
    "invitedBy": ObjectId | None,
    "createdAt": datetime,
    "updatedAt": datetime
}
```

**How admin is checked (from `pool_service.py:273-280`):**
```python
async def _is_org_admin(self, organization_id: str, user_id: str) -> bool:
    member = await self._org_members_collection.find_one({
        "organizationId": ObjectId(organization_id),
        "userId": ObjectId(user_id),
        "role": "admin"
    })
    return member is not None
```

**Admin Permissions for Circles:**
- Create pools (`PoolService.create_pool`)
- Send invitations (`InvitationService.send_invitations`)
- Update pools (`PoolService.update_pool`)
- Cancel pools (`PoolService.cancel_pool`)
- Assign groups (`GroupService.assign_groups`)
- Move members between groups (`GroupService.move_member`)
- Set group leaders (`GroupService.set_leader`)

---

### 2. Circle System Collections

| Collection | Purpose |
|------------|---------|
| `organizations` | Organization details (name, domain, settings) |
| `organizationMembers` | Role-based access (admin/member) |
| `circlePools` | Cohorts of participants within an organization |
| `circleInvitations` | Token-based invites to join pools |
| `circleGroups` | Small groups (3-6 members) within pools |
| `circleMeetings` | Scheduled video meetings for groups |
| `userAvailability` | Weekly time slots for finding common availability |

---

### 3. Invitation System

**Flow:**
1. Org Admin creates a pool in "draft" status
2. Admin transitions pool to "inviting" status via `start_inviting()`
3. Admin sends invitations via `InvitationService.send_invitations()`
4. Each invitation creates a record in `circleInvitations` with:
   - Unique 64-character token
   - Status: `pending` → `accepted` | `declined` | `expired` | `cancelled`
   - Email address, poolId, expiresAt (default 14 days)
5. Invitee receives email with accept/decline links
6. On accept: user added to organization (if not member), auto-assigned to group if possible

**Invitation Schema (`circleInvitations`):**
```python
{
    "_id": ObjectId,
    "poolId": ObjectId,
    "email": str,                  # Invitee email (lowercase)
    "firstName": str,              # Optional
    "lastName": str,               # Optional
    "token": str,                  # Unique 64-char token
    "status": str,                 # pending | accepted | declined | expired | cancelled
    "expiresAt": datetime,
    "invitedBy": ObjectId,
    "userId": ObjectId,            # Set on accept
    "acceptedAt": datetime,
    "emailSentAt": datetime,
    "createdAt": datetime,
    "updatedAt": datetime
}
```

---

### 4. Calendar Integration

**Tech Stack:** Google Calendar API with OAuth 2.0

**Flow:**
1. User connects calendar via OAuth (`GET /api/calendar/auth/google`)
2. Tokens encrypted (AES-256-CBC) and stored in `CalendarConnection`
3. When meeting scheduled (`MeetingService.schedule_meeting`):
   - Calendar events created for each member with connected calendar
   - Google Meet link auto-generated
   - Event IDs stored in `circleMeetings.calendarEvents[]`

**Meeting Schema (`circleMeetings`):**
```python
{
    "_id": ObjectId,
    "groupId": ObjectId,
    "title": str,
    "scheduledAt": datetime,
    "duration": int,               # Minutes
    "timezone": str,
    "meetingLink": str,            # Google Meet URL
    "status": str,                 # scheduled | in_progress | completed | cancelled
    "scheduledBy": ObjectId,
    "calendarEvents": [{
        "userId": ObjectId,
        "eventId": str,            # Google Calendar event ID
        "provider": str            # "google"
    }],
    "attendance": [{
        "userId": ObjectId,
        "status": str              # pending | accepted | declined | attended | no_show
    }],
    "reminder24hSent": bool,
    "reminder1hSent": bool,
    "createdAt": datetime,
    "updatedAt": datetime
}
```

---

### 5. Current Implementation Status

**Backend Services Implemented:**
- `OrganizationService` - Full implementation in `app_v2/services/organization/organization_service.py`
- `PoolService` - Full implementation in `app_v2/services/circles/pool_service.py`
- `GroupService` - Exists (needs verification)
- `InvitationService` - Exists (needs verification)
- `MeetingService` - Exists (needs verification)
- `AvailabilityService` - Exists (needs verification)

**Backend Routers Implemented:**
- `circles.py` - Member-facing endpoints only (my-groups, my-invitations, availability, meetings)
- `organization.py` - Organization management
- `admin.py` - Hub admin stats only

**Gap Identified:**
The current `circles.py` router lacks **admin-facing endpoints** for:
- Creating pools (`POST /api/circles/pools`)
- Getting pools for organization (`GET /api/circles/pools`)
- Sending invitations (`POST /api/circles/pools/:id/invitations`)
- Managing groups (`GET/POST/PUT /api/circles/pools/:id/groups`)
- Pool statistics (`GET /api/circles/pools/:id/stats`)

---

### 6. Files Reviewed

**Backend:**
- `app_v2/routers/circles.py` - Current circles router (member endpoints)
- `app_v2/routers/admin.py` - Hub admin router
- `app_v2/routers/organization.py` - Organization management
- `app_v2/services/organization/organization_service.py` - Full org service
- `app_v2/services/circles/pool_service.py` - Pool management service

**Documentation:**
- `docs/refactor/systems/circles.md` - Full circles system spec
- `docs/refactor/systems/organization.md` - Organization system spec
- `docs/v2/architecture/circles.md` - Architecture doc

**Frontend:**
- `docs/architecture/Circles.md` - Frontend circles page
- `docs/architecture/api/circles.md` - API endpoints used by frontend
- `docs/architecture/Admin.md` - Admin page (platform stats only)

---

### 7. Frontend Admin Check - GAP IDENTIFIED

**Sidebar.jsx (line 78):**
```javascript
const isAdmin = user?.role === 'admin' || user?.isHubAdmin || user?.isOrgAdmin;
```

The sidebar checks for `isOrgAdmin` but the backend does **NOT** provide this property.

**Backend auth/session response (auth.py:181-189):**
```python
return success_response({
    "user": {
        "id": str(user["_id"]),
        "email": user.get("email"),
        "firstName": user.get("profile", {}).get("firstName"),
        "lastName": user.get("profile", {}).get("lastName"),
        "isAdmin": user.get("isAdmin", False),  # Only isAdmin, NOT isOrgAdmin
    }
})
```

**GAPS:**
1. Backend `/auth/session` does not return `isOrgAdmin` or `isHubAdmin`
2. No circles-specific admin UI exists in the frontend
3. The `/admin` page is for Hub Admins only (platform stats), not Organization Admins
4. The Circles page (`Circles.jsx`) has no admin section/tab

**To Fix:**
1. Backend: Add `isOrgAdmin` to session response (requires checking `organizationMembers` for admin role)
2. Frontend: Add admin section to Circles page (or separate route like `/circles/admin`)
3. Backend: Expose pool admin endpoints in circles router

---

---

### 8. ANSWER: Circles Admin Page in deburnalpha

**1) Which page is this?**

In deburnalpha, the Circles Admin is a **separate "Admin" screen** (`#screen-admin` in `public/index.html:1205-1354`):

- Sidebar nav item with shield icon, class `admin-only` (hidden by default)
- Only visible to organization admins (checked via `GET /api/auth/admin-status`)
- Located at: `deburnalpha/public/index.html` lines 1205-1354

**Admin Screen UI:**
```
┌─────────────────────────────────────────┐
│ Hero: "Admin Panel - Manage invitations"│
├─────────────────────────────────────────┤
│ Pool Info: [Pool Name] [Status Badge]   │
├─────────────────────────────────────────┤
│ Send Invitations:                       │
│ ┌─────────────────────────────────────┐ │
│ │ Textarea for emails (comma/newline) │ │
│ └─────────────────────────────────────┘ │
│ [0 emails detected]    [Send Invitations]│
├─────────────────────────────────────────┤
│ Invited Users (count)                   │
│ ┌─────────────────────────────────────┐ │
│ │ Email | Status | Action             │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ Groups (count)      [Assign Groups btn] │
│ ┌─────────────────────────────────────┐ │
│ │ Group cards with member avatars     │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

**2) What backend stuff is needed?**

**Admin Status Check (in `routes/auth.js:531`):**
```
GET /api/auth/admin-status
→ Returns: { isAdmin: bool, organizations: [...] }
```

**Pool Management (in `routes/circles.js`):**
```
POST   /api/circles/pools                    - Create pool
GET    /api/circles/pools                    - Get pools (auto-detects org)
GET    /api/circles/pools/:id                - Get pool with invitations
PUT    /api/circles/pools/:id                - Update pool
POST   /api/circles/pools/:id/start          - Start inviting
POST   /api/circles/pools/:id/cancel         - Cancel pool
GET    /api/circles/pools/:id/stats          - Pool statistics
```

**Invitation Management:**
```
POST   /api/circles/pools/:id/invitations    - Send invitations (supports CSV)
GET    /api/circles/pools/:id/invitations    - List all invitations
DELETE /api/circles/invitations/:id          - Cancel invitation
```

**Group Management:**
```
POST   /api/circles/pools/:id/assign         - Assign members to groups
GET    /api/circles/pools/:id/groups         - List groups for pool
```

**Frontend Functions (in `prototype.js:5016-5533`):**
- `checkAdminStatus()` - Check if user is org admin
- `loadAdminData()` - Load pools, invitations, groups
- `sendAdminInvitations()` - Send invitations from textarea
- `removeAdminInvitation(id)` - Cancel an invitation
- `triggerAdminAssignment()` - Assign groups
- `renderAdminInvitations()` - Render invitation table
- `renderAdminGroups()` - Render group cards

---

## Next Steps

1. **Backend:** Add `GET /api/auth/admin-status` endpoint to `app_v2/routers/auth.py`
2. **Backend:** Expose pool admin endpoints in `app_v2/routers/circles.py`
3. ~~**Frontend:** Create Admin screen in Deburn-Frontend~~ DONE
4. ~~**Frontend:** Add admin-only nav item in Sidebar~~ DONE

---

## Frontend Implementation (18/01/26)

### Files Created

1. **`src/features/circles/circles-adminApi.js`**
   - API layer for admin endpoints
   - Methods: `getAdminStatus()`, `getPools()`, `getPool()`, `sendInvitations()`, `getPoolInvitations()`, `cancelInvitation()`, `assignGroups()`, `getPoolGroups()`

2. **`src/pages/CirclesAdmin.jsx`**
   - Main admin page component
   - Features:
     - Admin status check (redirects non-admins)
     - Pool info display with status badge
     - Email textarea for sending invitations
     - Invitation table with status and remove action
     - Groups section with assign button
   - Uses CSS classes from prototype.css (admin-*)

### Files Modified

1. **`src/App.jsx`**
   - Added import for `CirclesAdmin`
   - Added route: `/circles/admin` -> `<CirclesAdmin />`

2. **`src/components/layout/Sidebar.jsx`**
   - Changed admin link to point to `/circles/admin`
   - Shows for users with `isOrgAdmin` flag

### ~~Pending~~ Backend Work - COMPLETED

~~The frontend is ready but requires these backend endpoints:~~

All backend endpoints have been implemented:

| Endpoint | Status | File |
|----------|--------|------|
| `GET /api/auth/admin-status` | ✅ Done | `auth.py:283-330` |
| `GET /api/circles/pools` | ✅ Done | `circles.py:319-371` |
| `GET /api/circles/pools/:id` | ✅ Done | `circles.py:374-397` |
| `POST /api/circles/pools/:id/invitations` | ✅ Done | `circles.py:400-427` |
| `GET /api/circles/pools/:id/invitations` | ✅ Done | `circles.py:430-457` |
| `DELETE /api/circles/invitations/:id` | ✅ Done | `circles.py:460-495` |
| `POST /api/circles/pools/:id/assign` | ✅ Done | `circles.py:498-529` |
| `GET /api/circles/pools/:id/groups` | ✅ Done | `circles.py:532-582` |

---

## Backend Implementation (18/01/26)

### Files Modified

1. **`app_v2/routers/auth.py`**
   - Added `GET /admin-status` endpoint (lines 283-330)
   - Checks `organizationMembers` for admin role
   - Returns `isAdmin` boolean and list of admin organizations

2. **`app_v2/routers/circles.py`**
   - Added imports: `get_pool_service`, `Query`, `Optional`, `SendInvitationsRequest`
   - Added admin endpoints section (lines 315-582):
     - `GET /pools` - Get pools for admin's organizations
     - `GET /pools/:id` - Get pool details
     - `POST /pools/:id/invitations` - Send invitations
     - `GET /pools/:id/invitations` - List pool invitations
     - `DELETE /invitations/:id` - Cancel invitation
     - `POST /pools/:id/assign` - Assign groups
     - `GET /pools/:id/groups` - List groups with member details

3. **`app_v2/schemas/circles.py`**
   - Added `InviteeItem` schema (line 80-84)
   - Added `SendInvitationsRequest` schema (line 87-89)

4. **`app_v2/services/circles/invitation_service.py`**
   - Added `cancel_invitation()` method (lines 293-339)
   - Added `get_invitation_by_id()` method (lines 341-353)

### Integration Notes

- Admin check uses existing `organizationMembers` collection
- Pool admin authorization handled by existing `_is_org_admin()` in services
- All endpoints follow existing app_v2 patterns
- Response format uses `success_response()` wrapper

---

## Admin Tab Not Showing - Bug Fix (18/01/26)

### Problem

The Admin tab was not appearing in the frontend Sidebar for organization admins.

### Root Cause

The frontend Sidebar (`Sidebar.jsx:78`) checks:
```javascript
const isAdmin = user?.role === 'admin' || user?.isHubAdmin || user?.isOrgAdmin;
```

But the backend `/login` and `/session` endpoints were NOT returning `isOrgAdmin`. They only returned:
```python
{
    "id": ...,
    "email": ...,
    "firstName": ...,
    "lastName": ...,
    "isAdmin": ...  # System admin only, NOT org admin
}
```

### Solution

Modified both `/login` and `/session` endpoints in `app_v2/routers/auth.py` to:
1. Query `organizationmembers` collection
2. Check for documents where `userId` matches, `role` = `"admin"`, `status` = `"active"`
3. Return `isOrgAdmin: true/false` in the user object

### Files Modified

1. **`app_v2/routers/auth.py`**
   - `GET /session` (lines 183-217): Added org admin check, returns `isOrgAdmin`
   - `POST /login` (lines 139-175): Added org admin check, returns `isOrgAdmin`

### Architecture Decision

| Endpoint | Returns | Purpose |
|----------|---------|---------|
| `/login` | `isOrgAdmin: boolean` | Set on login, shows Admin tab |
| `/session` | `isOrgAdmin: boolean` | Refresh updates tab visibility |
| `/admin-status` | `isAdmin: boolean` + `organizations: []` | Real-time validation + org list for CirclesAdmin page |

**Note:** If a user is promoted to org admin mid-session, they need to refresh the page for the tab to appear. This is acceptable behavior - no polling required.

### Additional Fix

Fixed collection name typo in `/admin-status` endpoint:
- Changed `organizationMembers` → `organizationmembers` (line 298)
