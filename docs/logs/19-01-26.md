# Session Log - 19/01/26

## 14:00 (SGT) - Conversation Pipeline Implementation

Implemented encrypted conversation persistence using a pipeline architecture following SOLID principles. The pipeline handles all conversation storage/retrieval with AES-256-CBC encryption.

**Architecture Changes:**
- Created `app_v2/pipelines/conversation.py` - Stateless pipeline functions for encrypted storage
- CoachService now handles pure AI logic only (no persistence)
- Router (`coach.py`) orchestrates the pipeline

**Flow:**
```
Router (coach.py)
  ├── pipeline.get_or_create_conversation()  ← decrypt history
  ├── pipeline.save_message(user)            ← encrypt user msg
  ├── coach_service.chat(history)            ← pure AI logic
  ├── pipeline.save_message(assistant)       ← encrypt response
  └── pipeline.update_topics()
```

**Files Created:**
- `app_v2/pipelines/conversation.py`

**Files Modified:**
- `app_v2/routers/coach.py` - Uses pipeline for persistence
- `app_v2/routers/conversations.py` - Uses pipeline for GET/DELETE
- `app_v2/services/coach/coach_service.py` - Removed persistence logic
- `app_v2/dependencies.py` - Added `get_memory_encryption_service()`

---

## 15:00 (SGT) - Conversations API Endpoints

Added `/api/conversations` endpoints for conversation history management:

- `GET /api/conversations` - Retrieve most recent conversation (decrypted)
- `POST /api/conversations` - Sync endpoint (messages auto-stored during chat)
- `DELETE /api/conversations` - Clear all conversation history

**Storage Location:** `deburn-hub.conversations` (encrypted)

---

## 15:30 (SGT) - Frontend Local-First Sync

Implemented local-first conversation persistence in Coach.jsx:

1. On mount: Load from localStorage (instant display)
2. Background: Sync with backend (backend is source of truth)
3. On message: Save to localStorage + backend stores via chat

**localStorage Key:** `deburn_coach_conversation`

**Files Modified:**
- `Deburn-FrontEnd/src/pages/Coach.jsx` - Added localStorage sync
- `Deburn-FrontEnd/src/pages/Profile.jsx` - Added "Clear Conversation History" button

---

## 16:00 (SGT) - Actions Persistence

Fixed actions not persisting across page reloads. Actions are now saved with assistant message metadata.

**Backend Changes:**
- `coach.py` now collects actions from stream and saves in message metadata
- `conversations.py` returns actions with each assistant message

**Frontend Changes:**
- `Coach.jsx` includes actions when loading from backend

**Data Model:**
```json
{
  "messages": [{
    "role": "assistant",
    "content": "encrypted content",
    "metadata": {
      "topics": ["stress"],
      "actions": [{"type": "exercise", "id": "...", "label": "..."}]
    }
  }]
}
```

---

## Summary

Conversation history now persists with:
- AES-256-CBC encryption in MongoDB (deburn-hub.conversations)
- Local-first display via localStorage
- Backend as source of truth for sync
- Actions saved and restored with messages
- Clear history button in Profile/Settings page
