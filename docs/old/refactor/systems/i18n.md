# Internationalization System

## Description

The Internationalization (i18n) System provides multi-language support for the application. It manages translation loading, language detection, and provides request-scoped translation functions for localized API responses and emails.

**Responsibilities:**
- Load and cache translations from files (with database option for future)
- Translate keys with dot notation access
- Support variable interpolation (`{{varName}}`)
- Support pluralization (`{one: "...", other: "..."}`)
- Detect user's preferred language from profile or request headers
- Provide Express middleware with `req.t()` helper
- Hot reload translations without server restart

**Tech Stack:**
- **JSON Files** - Translation storage (`public/locales/{lang}/*.json`, `locales/emails/{lang}.json`)
- **MongoDB** - Language configuration and future translation storage
- **Express Middleware** - Language detection and request-scoped helpers

**Supported Languages:**
| Code | Language |
|------|----------|
| en | English (default) |
| sv | Swedish |

**Translation Namespaces:**
- `auth` - Authentication UI strings
- `checkin` - Check-in UI strings
- `circles` - Circles/groups UI strings
- `coach` - AI coach UI strings
- `common` - Shared UI strings
- `dashboard` - Dashboard UI strings
- `errors` - Error messages
- `learning` - Learning content UI strings
- `profile` - Profile UI strings
- `progress` - Progress UI strings
- `validation` - Validation error messages
- `emails` - Email templates (backend only)

---

## Pipelines

### Pipeline 1: Translate Key

Translates a key to the user's language with interpolation and pluralization support.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          TRANSLATE KEY PIPELINE                              │
└─────────────────────────────────────────────────────────────────────────────┘

Input                            I18nService                         Output
─────                            ───────────                         ──────
    │                                │                                   │
    │  key: "validation.email.required"                                  │
    │  lang: "sv"                    │                                   │
    │  options: {}                   │                                   │
    │───────────────────────────────>│                                   │
    │                                │                                   │
    │                                │  1. Check if lang is supported    │
    │                                │     (sv in ['en', 'sv']? Yes)     │
    │                                │                                   │
    │                                │  2. Parse key into parts          │
    │                                │     namespace: "validation"       │
    │                                │     path: ["email", "required"]   │
    │                                │                                   │
    │                                │  3. Look up in translations[sv]   │
    │                                │     → translations["sv"]          │
    │                                │       ["validation"]              │
    │                                │       ["email"]["required"]       │
    │                                │                                   │
    │                                │  4. If not found, fallback to 'en'│
    │                                │                                   │
    │                                │  5. If still not found,           │
    │                                │     log warning, return key       │
    │                                │                                   │
    │                                │  6. Handle pluralization          │
    │                                │     (if options.count provided)   │
    │                                │                                   │
    │                                │  7. Interpolate variables         │
    │                                │     {{name}} → options.name       │
    │                                │                                   │
    │                                │                 "E-post krävs"    │
    │                                │────────────────────────────────────>
    │                                │                                   │
```

**Steps:**
1. Check if requested language is in supported languages list
2. If not supported, use default language ('en')
3. Parse key: first segment is namespace, rest is path within namespace
4. Traverse translations object using dot notation path
5. If value not found in requested language, try default language
6. If still not found, log warning and return the key as-is
7. If `options.count` provided and value is object with `one`/`other`, select based on count
8. Replace `{{varName}}` placeholders with values from options object
9. Return translated string

**Interpolation Example:**
```
Key: "validation.password.minLength"
Value: "Password must be at least {{min}} characters"
Options: { min: 8 }
Result: "Password must be at least 8 characters"
```

**Pluralization Example:**
```
Key: "progress.streak"
Value: { one: "{{count}} day streak", other: "{{count}} days streak" }
Options: { count: 1 }
Result: "1 day streak"

Options: { count: 5 }
Result: "5 days streak"
```

**Error Cases:**
- Language not supported → Use default language
- Key not found → Log warning, return key string

---

### Pipeline 2: Detect Language

Determines the user's preferred language from the request context.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        DETECT LANGUAGE PIPELINE                              │
└─────────────────────────────────────────────────────────────────────────────┘

Request                          I18nMiddleware                      Result
───────                          ──────────────                      ──────
    │                                │                                   │
    │  req.user.profile.preferredLanguage: "sv"                          │
    │  Accept-Language: "en-US,en;q=0.9"                                 │
    │───────────────────────────────>│                                   │
    │                                │                                   │
    │                                │  1. Check user profile            │
    │                                │     (authenticated request?)      │
    │                                │                                   │
    │                                │     YES: Check preferredLanguage  │
    │                                │     ┌─────────────────────────┐   │
    │                                │     │ user.profile            │   │
    │                                │     │   .preferredLanguage    │   │
    │                                │     │ = "sv"                  │   │
    │                                │     │                         │   │
    │                                │     │ Is "sv" supported? Yes  │   │
    │                                │     └─────────────────────────┘   │
    │                                │     → Return "sv"                 │
    │                                │                                   │
    │                                │     NO user/no preference:        │
    │                                │                                   │
    │                                │  2. Parse Accept-Language header  │
    │                                │     "en-US,en;q=0.9" → "en"       │
    │                                │                                   │
    │                                │     Is "en" supported? Yes        │
    │                                │     → Return "en"                 │
    │                                │                                   │
    │                                │  3. No match found                │
    │                                │     → Return default "en"         │
    │                                │                                   │
    │                                │                          "sv"     │
    │                                │────────────────────────────────────>
    │                                │                                   │
```

**Priority Order:**
1. **User Profile** - `req.user.profile.preferredLanguage` (if authenticated)
2. **Accept-Language Header** - Browser's language preference
3. **Default** - Fallback to 'en'

**Steps:**
1. Check if request has authenticated user with `profile.preferredLanguage`
2. If found and language is supported, use it
3. Otherwise, parse `Accept-Language` header (take primary language before comma/semicolon)
4. If parsed language is supported, use it
5. Otherwise, return default language ('en')

**Accept-Language Parsing:**
```
"sv-SE,sv;q=0.9,en;q=0.8" → "sv" (primary, before hyphen)
"en-US,en;q=0.9" → "en"
"fr,de;q=0.8" → "fr" (not supported) → "en" (default)
```

---

### Pipeline 3: Reload Translations

Hot reload translations from source without server restart.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       RELOAD TRANSLATIONS PIPELINE                           │
└─────────────────────────────────────────────────────────────────────────────┘

Admin Request                    I18nService                         Result
─────────────                    ───────────                         ──────
    │                                │                                   │
    │  POST /admin/i18n/reload       │                                   │
    │───────────────────────────────>│                                   │
    │                                │                                   │
    │                                │  1. Clear translations cache      │
    │                                │     translations = {}             │
    │                                │                                   │
    │                                │  2. Reload language config        │
    │                                │     (get supported languages)     │
    │                                │                                   │
    │                                │  3. For each supported language:  │
    │                                │     ┌─────────────────────────┐   │
    │                                │     │ Load from file system   │   │
    │                                │     │ public/locales/{lang}/  │   │
    │                                │     │   *.json                │   │
    │                                │     │                         │   │
    │                                │     │ OR (future)             │   │
    │                                │     │ Load from database      │   │
    │                                │     └─────────────────────────┘   │
    │                                │                                   │
    │                                │  4. Load email translations       │
    │                                │     locales/emails/{lang}.json    │
    │                                │                                   │
    │                                │  5. Log reload completion         │
    │                                │                                   │
    │                                │        { success: true,           │
    │                                │          languages: ["en", "sv"], │
    │                                │          namespaces: 12 }         │
    │                                │────────────────────────────────────>
    │                                │                                   │
```

**Steps:**
1. Clear the in-memory translations cache
2. Fetch current list of supported languages from config/database
3. For each language, load all namespace files from `public/locales/{lang}/`
4. Load email translations from `locales/emails/{lang}.json`
5. Log completion with count of languages and namespaces loaded
6. Return success response with reload statistics

**Use Cases:**
- Translations updated in files while server running
- New language added to configuration
- Fix typo in translation without server restart

---

### Pipeline 4: Get Supported Languages

Returns the list of available languages for the application.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     GET SUPPORTED LANGUAGES PIPELINE                         │
└─────────────────────────────────────────────────────────────────────────────┘

Request                          LanguageConfig                       Result
───────                          ──────────────                       ──────
    │                                │                                   │
    │  GET /api/languages            │                                   │
    │───────────────────────────────>│                                   │
    │                                │                                   │
    │                                │  1. Check source mode             │
    │                                │                                   │
    │                                │     FILE MODE:                    │
    │                                │     ┌─────────────────────────┐   │
    │                                │     │ Read from config file   │   │
    │                                │     │ supportedLanguages:     │   │
    │                                │     │   ['en', 'sv']          │   │
    │                                │     └─────────────────────────┘   │
    │                                │                                   │
    │                                │     DATABASE MODE (future):       │
    │                                │     ┌─────────────────────────┐   │
    │                                │     │ Query languages         │   │
    │                                │     │ collection where        │   │
    │                                │     │ enabled: true           │   │
    │                                │     └─────────────────────────┘   │
    │                                │                                   │
    │                                │  2. Format response               │
    │                                │                                   │
    │                                │        { languages: [             │
    │                                │            { code: "en",          │
    │                                │              name: "English",     │
    │                                │              isDefault: true },   │
    │                                │            { code: "sv",          │
    │                                │              name: "Svenska",     │
    │                                │              isDefault: false }   │
    │                                │        ]}                         │
    │                                │────────────────────────────────────>
    │                                │                                   │
```

**Steps:**
1. Check configuration source mode (file or database)
2. In file mode: read from config constant/environment
3. In database mode: query languages collection for enabled languages
4. Format response with code, display name, and default flag
5. Return list to client

---

## Components

### I18nService

Core translation service that loads, caches, and retrieves translations.

```python
class I18nService:
    """
    Handles translation loading and lookup.
    Supports file-based storage with optional database source.
    Singleton instance created at app startup.
    """

    def __init__(self, language_config: LanguageConfig, source_mode: str = "file"):
        """
        Initialize i18n service.

        Args:
            language_config: Configuration for supported languages
            source_mode: "file" or "database"
        """

    def load_translations(self) -> None:
        """
        Load all translations from configured source.
        Called at startup and on reload.

        Side Effects:
            - Clears existing translations cache
            - Loads UI translations from public/locales/{lang}/*.json
            - Loads email translations from locales/emails/{lang}.json
            - Logs loaded languages and namespace count
        """

    def load_from_files(self, lang: str) -> dict:
        """
        Load translations for a language from JSON files.

        Args:
            lang: Language code (e.g., 'en', 'sv')

        Returns:
            dict mapping namespace → translations dict

        File Structure:
            public/locales/{lang}/
                auth.json
                checkin.json
                common.json
                ...
        """

    def load_from_database(self, lang: str) -> dict:
        """
        Load translations for a language from database.
        Future implementation for database-backed translations.

        Args:
            lang: Language code

        Returns:
            dict mapping namespace → translations dict
        """

    def load_email_translations(self, lang: str) -> dict:
        """
        Load email-specific translations (backend only).

        Args:
            lang: Language code

        Returns:
            dict with email template translations

        File: locales/emails/{lang}.json
        """

    def t(self, key: str, lang: str = "en", options: dict = None) -> str:
        """
        Translate a key to the specified language.

        Args:
            key: Dot notation key (e.g., 'validation.email.required')
            lang: Target language code
            options: Interpolation values and count for pluralization
                - count: int for pluralization selection
                - **kwargs: Values for {{varName}} interpolation

        Returns:
            Translated string, or key if not found

        Examples:
            t('common.greeting', 'en', {'name': 'Alice'})
            → "Hello, Alice!"

            t('progress.days', 'en', {'count': 5})
            → "5 days" (pluralized)
        """

    def get_nested_value(self, obj: dict, path_parts: list[str]) -> str | dict | None:
        """
        Traverse nested dict using path parts.

        Args:
            obj: Dictionary to traverse
            path_parts: List of keys to follow

        Returns:
            Value at path, or None if not found
        """

    def interpolate(self, text: str, options: dict) -> str:
        """
        Replace {{varName}} placeholders with values.

        Args:
            text: String with placeholders
            options: Values to interpolate

        Returns:
            String with placeholders replaced
        """

    def pluralize(self, value: dict, count: int) -> str:
        """
        Select plural form based on count.

        Args:
            value: Dict with 'one' and 'other' keys
            count: Number to determine plural form

        Returns:
            Selected plural form string
        """

    def reload(self) -> dict:
        """
        Hot reload translations from source.

        Returns:
            dict with reload statistics:
                - success: bool
                - languages: list of loaded language codes
                - namespaces: count of loaded namespaces
        """

    def is_supported(self, lang: str) -> bool:
        """
        Check if a language is supported.

        Args:
            lang: Language code to check

        Returns:
            True if language is in supported list
        """

    def get_supported_languages(self) -> list[str]:
        """
        Get list of supported language codes.

        Returns:
            List of language codes (e.g., ['en', 'sv'])
        """
```

---

### I18nMiddleware

Express middleware that attaches language detection and translation helpers to requests.

```python
class I18nMiddleware:
    """
    Express middleware for request-scoped i18n.
    Attaches req.language and req.t() to all requests.
    """

    def __init__(self, i18n_service: I18nService, language_config: LanguageConfig):
        """
        Args:
            i18n_service: Translation service instance
            language_config: For supported language lookup
        """

    def middleware(self) -> callable:
        """
        Return Express middleware function.

        Returns:
            Middleware that:
                - Detects language from request
                - Attaches req.language (string)
                - Attaches req.t(key, options) function

        Usage:
            app.use(i18n_middleware.middleware())
        """

    def get_language_from_request(self, request: Request) -> str:
        """
        Detect user's preferred language from request.

        Args:
            request: HTTP request object

        Returns:
            Language code (e.g., 'en', 'sv')

        Priority:
            1. req.user.profile.preferredLanguage (if authenticated)
            2. Accept-Language header (primary language)
            3. Default language ('en')
        """

    def parse_accept_language(self, header: str) -> str | None:
        """
        Parse Accept-Language header to extract primary language.

        Args:
            header: Accept-Language header value
                e.g., "sv-SE,sv;q=0.9,en;q=0.8"

        Returns:
            Primary language code (e.g., 'sv'), or None if invalid
        """
```

---

### LanguageConfig

Manages the list of supported languages from configuration or database.

```python
class LanguageConfig:
    """
    Configuration for supported languages.
    Supports file-based config with option for database storage.
    """

    def __init__(self, db: Database = None, source_mode: str = "file"):
        """
        Args:
            db: MongoDB database connection (for database mode)
            source_mode: "file" or "database"
        """

    def get_supported_languages(self) -> list[dict]:
        """
        Get list of supported languages with metadata.

        Returns:
            List of language dicts:
                [
                    { "code": "en", "name": "English", "isDefault": True },
                    { "code": "sv", "name": "Svenska", "isDefault": False }
                ]
        """

    def get_language_codes(self) -> list[str]:
        """
        Get list of supported language codes only.

        Returns:
            List of codes (e.g., ['en', 'sv'])
        """

    def get_default_language(self) -> str:
        """
        Get the default language code.

        Returns:
            Default language code (e.g., 'en')
        """

    def is_supported(self, lang: str) -> bool:
        """
        Check if a language code is supported.

        Args:
            lang: Language code to check

        Returns:
            True if supported, False otherwise
        """

    def add_language(self, code: str, name: str, is_default: bool = False) -> dict:
        """
        Add a new supported language.
        Only available in database mode.

        Args:
            code: Language code (e.g., 'de')
            name: Display name (e.g., 'Deutsch')
            is_default: Whether this is the default language

        Returns:
            Created language dict

        Raises:
            NotImplementedError: If in file mode
            ValueError: If language code already exists
        """

    def remove_language(self, code: str) -> bool:
        """
        Remove a supported language.
        Only available in database mode.
        Cannot remove default language.

        Args:
            code: Language code to remove

        Returns:
            True if removed

        Raises:
            NotImplementedError: If in file mode
            ValueError: If trying to remove default language
        """

    def reload(self) -> None:
        """
        Reload language configuration from source.
        Used when config file or database is updated.
        """
```

---

## Data Models

### Language (Database Mode - Future)

```python
# languages collection
{
    "_id": ObjectId,
    "code": str,              # ISO 639-1 code (e.g., "en", "sv")
    "name": str,              # Display name (e.g., "English", "Svenska")
    "nativeName": str,        # Name in native language
    "isDefault": bool,        # True for default language
    "enabled": bool,          # Whether language is active
    "createdAt": datetime,
    "updatedAt": datetime
}
```

### Translation (Database Mode - Future)

```python
# translations collection
{
    "_id": ObjectId,
    "lang": str,              # Language code
    "namespace": str,         # Namespace (e.g., "validation", "common")
    "key": str,               # Translation key (e.g., "email.required")
    "value": str | dict,      # Translation value (string or plural object)
    "updatedAt": datetime
}
```

**Indexes:**
- `{ lang: 1, namespace: 1 }` - For loading all translations for a language
- `{ lang: 1, namespace: 1, key: 1 }` - Unique, for individual key lookup

---

## Configuration

### File Mode (Current)

```python
# config.py or environment
I18N_SOURCE_MODE = "file"
I18N_DEFAULT_LANGUAGE = "en"
I18N_SUPPORTED_LANGUAGES = ["en", "sv"]

# File paths
I18N_LOCALES_PATH = "public/locales"
I18N_EMAILS_PATH = "locales/emails"
```

### Database Mode (Future)

```python
# config.py or environment
I18N_SOURCE_MODE = "database"
I18N_DEFAULT_LANGUAGE = "en"
# Languages loaded from database 'languages' collection
# Translations loaded from database 'translations' collection
```

### Caching Toggle

```python
# Option to disable translation caching (useful for development)
I18N_CACHE_ENABLED = True  # Set False to reload on every request
```
